<!DOCTYPE html>
<html lang="en">
<head>
<title>Book Samples</title>
<style type="text/css" media="screen">
    #editor_div { 
        position: absolute;
        display: block;
        top: 32px;
        right: 0;
        bottom: 10px;
        left: 0;
    }
    #controls_div { 
        position: absolute;
        display: block;
        left: 0;
        top: 0;
        right: 0;
        height: 32px;
    }
    #editor_frame_div {
        position: absolute;
        display: block;
        border: 1px solid;
        padding: 0px; 
        width: 45%;
        top: 50px;
        bottom: 20px;
        resize: both;
        overflow: auto;
        background-color: #ddd;
        font-family: Arial, Helvetica, sans-serif;
        font-size: 14px;

    }
    #script_output_textarea {
        position: absolute;
        display: block;
        left:46%;
        top:50px;
        width:200px;
        height:200px;
    }
    #btn_run {
/*
        background-color: #4CAF50;
        border: none;
        color: white;
        padding: 15px 32px;
*/
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 32px;
        font-family: Arial, Helvetica, sans-serif;
        font-weight: bold;
    }
    body {
      font-family: Arial, Helvetica, sans-serif;
    }
</style>
</head>
<body>

<!-- <script type="text/javascript" src="http://code.jquery.com/jquery-1.11.1.min.js"></script> -->


<!-- Editor info: https://ace.c9.io/#nav=embedding
 -->
These are code samples for a book project.

<div id="editor_frame_div">
    <div id="controls_div">
        <input type="button" id="btn_run" value="Run Program" onclick="handle_run_button();">
        <input id="chk_theme" type="checkbox" onchange="handle_checkboxes();">
        <label for="chk_theme">Dark theme</label>
        <span id="example_choice_span">
            <select id="example_choice_sel">
            </select>
        </span>
    </div>
    <div id="editor_div">
    </div>
</div>
<textarea id="script_output_textarea" style="resize:both;">
(program output goes here)
</textarea>



<script src="./external/ace/src-min-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>
<script>    
    var editor = ace.edit("editor_div");
    editor.session.setMode("ace/mode/javascript");

var editor_div = document.getElementById('editor_div');
var editor_frame_div = document.getElementById('editor_frame_div');
var example_choice_span = document.getElementById('example_choice_span');
var script_output_textarea = document.getElementById('script_output_textarea');


function handle_run_button()
{
    run_script();
    show_state_vector();
}

function handle_checkboxes()
{
    if (document.getElementById('chk_theme').checked)
    {
        editor.setTheme("ace/theme/monokai");
        editor_frame_div.style.backgroundColor = '#444';
        editor_frame_div.style.color = 'white';
    }
    else
    {
        editor.setTheme("");
        editor_frame_div.style.backgroundColor = '#ddd';
        editor_frame_div.style.color = 'black';
    }

}
///////////////////////////////////////////////////////////////
// This is a small workaround for the issue where the editor
// doesn't get informed about size changes
var last_editor_div_width = 0;
var last_editor_div_height = 0;
function check_for_editor_resize()
{
    var seconds_per_check_for_editor_resize = 0.5;
    var w = editor_div.offsetWidth;
    var h = editor_div.offsetHeight;
    if (w != last_editor_div_width || h != last_editor_div_height)
    {
        editor.resize();
        last_editor_div_width = w;
        last_editor_div_height = h;
    }
    window.setTimeout(check_for_editor_resize,
                      1000 * seconds_per_check_for_editor_resize);
}
window.onload = function() {
    check_for_editor_resize();
    make_sample_menu();
};

</script>



<!-- ////////////////////////////////////////////////////////////////////// -->
<script> 
// This list contains an entry for each sample in this pager, aling with the
// preferred display size of various elements.
// menu_name - The name which will show up in the visible menu
// id        - The name of the textarea which contains the program. Also the url key to load it directly
// num_instructions - The number of columns in the gates diaplay.
// num_circle_rows   - The number of rows in the circles display.
// num_circle_cols   - The number of columns in the circles display.
var sample_list = [
    { menu_name: 'Ex 3.1: Logic 1', id: 'logic1', num_qubits: 3, num_instructions: 17, num_circle_cols: 8, num_circle_rows: 1, circle_scale: 1.0, gate_scale: 1.0},
    { menu_name: 'Ex 3.2: Logic 2', id: 'logic2', num_qubits: 4, num_instructions: 17, num_circle_cols: 16, num_circle_rows: 1, circle_scale: 1.0, gate_scale: 1.0},

    { menu_name: 'Ex 6.1: Grover 1', id: 'grover1', num_qubits: 4, num_instructions: 12, num_circle_cols: 16, num_circle_rows: 1, circle_scale: 1.0, gate_scale: 1.0},
    { menu_name: 'Ex 6.2: Grover 2', id: 'grover2', num_qubits: 4, num_instructions: 39, num_circle_cols: 4, num_circle_rows: 4, circle_scale: 1.0, gate_scale: 1.0},

    { menu_name: 'Ex 7.1: QFT 1',    id: 'qft1', num_qubits: 4, num_instructions: 12, num_circle_cols: 16, num_circle_rows: 1, circle_scale: 1.0, gate_scale: 1.0},
    { menu_name: 'Ex 7.2: QFT 2',    id: 'qft2', num_qubits: 4, num_instructions: 15, num_circle_cols: 16, num_circle_rows: 1, circle_scale: 1.0, gate_scale: 1.0},
    { menu_name: 'Ex 7.3: QFT 3',    id: 'qft3', num_qubits: 4, num_instructions: 13, num_circle_cols: 16, num_circle_rows: 1, circle_scale: 1.0, gate_scale: 1.0},
    { menu_name: 'Ex 7.10: QFT 10',  id: 'qft10', num_qubits: 4, num_instructions: 11, num_circle_cols: 16, num_circle_rows: 1, circle_scale: 1.0, gate_scale: 1.0},
    { menu_name: 'Ex 7.11: QFT 11',  id: 'qft11', num_qubits: 4, num_instructions: 16, num_circle_cols: 16, num_circle_rows: 1, circle_scale: 1.0, gate_scale: 1.0},

    { menu_name: 'Ex 14.1: Shor 1',  id: 'shor1', num_qubits: 4, num_instructions: 14, num_circle_cols: 16, num_circle_rows: 1, circle_scale: 1.0, gate_scale: 1.0},
    { menu_name: 'Ex 14.2: Shor 2',  id: 'shor2', num_qubits: 4, num_instructions: 14, num_circle_cols: 16, num_circle_rows: 1, circle_scale: 1.0, gate_scale: 1.0},
    { menu_name: 'Ex 14.7: Shor 7',  id: 'shor7', num_qubits: 4, num_instructions: 14, num_circle_cols: 16, num_circle_rows: 1, circle_scale: 1.0, gate_scale: 1.0},
];

function make_sample_menu()
{
    str = '';
    str += '<select id="example_choice_sel" onchange="example_menu_changed();">';
    for (i = 0; i < sample_list.length; ++i)
    {
        sample = sample_list[i];
        str += '<option value="' + sample.id + '">';
        str += sample.menu_name;
        str += '</option>';
    }
    str += '</select>';
    example_choice_span.innerHTML = str;

    try_to_get_program_from_url()
    example_menu_changed();
}

// get_url_param() is adapted from JeffreyCrofte's work here: https://www.creativejuiz.fr/blog/en/javascript-en/read-url-get-parameters-with-javascript
function get_url_param(param) {
  var vars = {};
  window.location.href.replace( location.hash, '' ).replace( 
    /[?&]+([^=&]+)=?([^&]*)?/gi, // regexp
    function( m, key, value ) { // callback
      vars[key] = value !== undefined ? value : '';
    }
  );
  if (param) {
    return vars[param] ? vars[param] : null;  
  }
  return vars;
}

function try_to_get_program_from_url()
{
  var program_id = get_url_param('p');
  if (program_id)
  {
    for (i = 0; i < sample_list.length; ++i)
    {
      sample = sample_list[i];
      if (program_id == sample.id)
      {
        menu = document.getElementById('example_choice_sel');
        menu.value = program_id;
        return true;
      }
    }
  }
  return false;
}

function example_menu_changed()
{
    menu = document.getElementById('example_choice_sel');
    load_example(menu.value);
    handle_run_button();
    rewind_to_beginning();
    clear_output();
}

function load_example(id)
{
    for (i = 0; i < sample_list.length; ++i)
    {
        sample = sample_list[i];
        if (sample.id == id)
        {
            source_area = document.getElementById(id);
            if (source_area != null)
            {
                editor.focus();
                editor.setValue(source_area.value);
                editor.gotoLine(0);
                setup_script_panels(sample);
            }
            return;
        }
    }
}

function LoadUserName() {}

function setup_script_panels(sample)
{
    if (panel_staff)
    {
        // console.log('div');
        // console.log(panel_staff);
        // console.log(panel_staff.div);
        // panel_staff.div.style.scroll = 'both';
        qc_options.color_by_phase = false;
        qc_options.circle_scale = 0.5;
        qc.start();
        qc.enableAnimation();
        // qc.reset(sample.num_qubits);
        // qc.write(0);
        // qint.new(sample.num_qubits, 'reg');

        var left = 400;
        var top = 250;
        var gate_grid = 20;
        var circle_grid = 64;
        var gate_width = 100 + 20 + gate_grid * sample.num_instructions;
        var gate_height = 80 + gate_grid * sample.num_qubits;
        panel_staff.setPos(left, top);
        panel_staff.setSize(gate_width, gate_height);
        top += gate_height + 32;
        var circle_width = 20 + circle_grid * sample.num_circle_cols;
        var circle_height = 150 + circle_grid * sample.num_circle_rows;
        panel_chart.setPos(left, top);
        panel_chart.setSize(circle_width, circle_height);
        panel_staff.setVisible(true);
        panel_chart.setVisible(true);

        panel_staff.draw();
        panel_chart.draw();
    }
}

function run_script()
{
    qc_options.color_by_phase = false;
    qc_options.circle_scale = 0.5;
    qc.start();
    if (qc) {
//      qc.disableAnimation();
//      qc.enableRecording();
      qc.codeLabel('');
    }

    qc.enableAnimation();

    runQCScriptInTextArea('editor', 'script_output_textarea');

    qc.qReg.changed();
    panel_staff.draw();
    panel_chart.draw();

    qc.enableAnimation();
}

function clear_output()
{
  script_output_textarea.value = '(output prints here)\n';
}

function rewind_to_beginning()
{
  console.log('instructions: ' + qc.qReg.staff.insertionStart);
  qc.qReg.staff.rewind_insertion_to_start();
}

function show_state_vector()
{
  list = panel_chart.widgets;
  for (var i = 0; i < list.length; ++i)
  {
    if (list[i].stateVector)
    {
      console.log(list[i]);
      list[i].collapsed = false;
    }
  }
}

</script>

<textarea id="logic1" style="display:none;">
qc_options.color_by_phase = 1;
qc_options.book_render = 1;
qc.reset(3);
var a = qint.new(1, 'a')
var b = qint.new(1, 'b')
var c = qint.new(1, 'c')

qc.codeLabel('c = ~c');
c.write(0);
qc.nop();
c.not();
qc.nop();
c.read();
qc.codeLabel('');
qc.nop();

qc.codeLabel('if (b) then c = ~c');
qc.write(2, 2|4);
qc.nop();
c.cnot(b);
qc.nop();
qc.read(2|4);
qc.codeLabel('');
qc.nop();

qc.codeLabel('if (a and b) then c = ~c');
qc.write(1|2);
qc.nop();
qc.cnot(4, 1|2);
qc.nop();
qc.read(1|2|4);
qc.codeLabel('');
qc.nop();
</textarea>

<textarea id="logic2" style="display:none;">
// Initialize
num_qubits = 4;
qc_options.color_by_phase = true;
qc.reset(num_qubits);
a = qint.new(num_qubits, 'a');

// prepare
qc.codeLabel('prepare');
a.write(1);
a.hadamard(0x4);
a.phase(45, 0x4);
qc.codeLabel('');

qc.nop();
qc.nop();

// increment
qc.codeLabel('increment');
a.add(1);
qc.codeLabel('');

qc.nop();
qc.nop();

// increment
qc.codeLabel('decrement');
a.subtract(1);
qc.codeLabel('');

qc.nop();
</textarea>

<textarea id="grover1" style="display:none;">
var number_to_flip = 3;

qc_options.color_by_phase = 1;
qc_options.book_render = 1;
var num_qubits = 4;
qc.reset(num_qubits);
var reg = qint.new(num_qubits, 'reg')

reg.write(0);
qc.codeLabel('prep');
reg.hadamard();
qc.codeLabel('');
qc.nop();

// Flip the marked value
qc.codeLabel('flip');
reg.not(~number_to_flip);
reg.phase(180);
reg.not(~number_to_flip);
qc.codeLabel('');

qc.codeLabel('Grover');
reg.Grover();
qc.codeLabel('');
qc.nop();
</textarea>

<textarea id="grover2" style="display:none;">
var number_to_flip = 3;
var number_of_iterations = 4;

qc_options.color_by_phase = 1;
qc_options.book_render = 1;
var num_qubits = 4;
qc.reset(num_qubits);
var reg = qint.new(num_qubits, 'reg')

reg.write(0);
qc.codeLabel('prep');
reg.hadamard();
qc.codeLabel('');
qc.nop();

for (var i = 0; i < number_of_iterations; ++i)
{
    prob = reg.peekProbability(number_to_flip);
    qc.print('prob before: ' + prob + '\n');

    // Flip the marked value
    qc.codeLabel('flip ' + (i + 1));
    reg.not(~number_to_flip);
    reg.phase(180);
    reg.not(~number_to_flip);
    qc.codeLabel('');

    qc.codeLabel('Grover ' + (i + 1));
    reg.Grover();
    qc.codeLabel('');
    qc.nop();
    
    prob = reg.peekProbability(number_to_flip);
    qc.print('prob after: ' + prob + '\n');
    prob = reg.peekProbability(0);
    qc.print('alt prob after: ' + prob + '\n');
}
</textarea>

<textarea id="qft1" style="display:none;">
qc_options.color_by_phase = 1;
qc_options.book_render = 1;
var num_qubits = 4;
qc.reset(num_qubits);
var signal = qint.new(num_qubits, 'signal')

// prepare the signal A
signal.write(0);
signal.hadamard();
signal.phase(180, 1);

// prepare the signal B
signal.write(0);
signal.hadamard();
signal.phase(90, 1);
signal.phase(180, 2);

// prepare the signal C
signal.write(0);
signal.hadamard();
signal.phase(45, 1);
signal.phase(90, 2);
signal.phase(180, 4);
</textarea>

<textarea id="qft2" style="display:none;">
var num_qubits = 4;
qc.reset(num_qubits);
var signal = qint.new(num_qubits, 'signal')

// prepare the signal
signal.write(0);
signal.hadamard();
signal.phase(45, 1);
signal.phase(90, 2);
signal.phase(180, 4);

// Run the QFT
signal.QFT()
</textarea>

<textarea id="qft3" style="display:none;">
var num_qubits = 4;
qc.reset(num_qubits);
var signal = qint.new(num_qubits, 'signal')
var wave_period = 2; // A:1 B:2 C:4 D:8

// prepare the signal
signal.write(0);
signal.hadamard();
signal.phase(180, wave_period);

signal.QFT()
</textarea>

<textarea id="qft10" style="display:none;">
// Setup
var num_qubits = 4;
qc.reset(num_qubits);
var qin = qint.new(num_qubits, 'qin');

// Write the frequency we want to register
qin.write(3);

// Inverse QFT to turn into a signal
qin.invQFT()
</textarea>

<textarea id="qft11" style="display:none;">
// Setup
var num_qubits = 4;
qc.reset(num_qubits);
var qin = qint.new(num_qubits, 'qin');
qin.write(0);

// Write the frequencies we want to register
qin.had(1);
qc.cnot(14,1);
qin.not(2);
qc.cnot(1,2);
qin.not(2);

//Inverse QFT to turn into a signal
qin.invQFT()
</textarea>

<textarea id="shor1" style="display:none;">
function shor_sample() {
    N = 35;             // The number we're factoring
    precision_bits = 4; // See the text for a description of this
    coprime = 2;        // For this QPU implementation, this must be 2

    result = Shor(N, precision_bits, coprime);
}

function Shor(N, precision_bits, coprime) {
    repeat_period = ShorQPU(N, precision_bits, coprime);  // the quantum part
    factors = ShorLogic(N, repeat_period, coprime);       // the classical part
    return factors;
}

function ShorLogic(N, repeat_period, coprime) {
    // Given the repeat period, find the actual factors
    ar2 = Math.pow(coprime, repeat_period / 2.0);
    factor1 = gcd(N, ar2 - 1);
    factor2 = gcd(N, ar2 + 1);
    return [factor1, factor2];
}
</textarea>

<textarea id="shor2" style="display:none;">
function ShorQPU_placeholder(N, precision_bits, coprime) {
    // Classical replacement for the quantum part of Shor
    work = 1;
    max_loops = Math.pow(2, precision_bits);
    for (iter = 0; iter < max_loops; ++iter) {
        work = (work * coprime) % N;
        if (work == 1) // found the repeat
            return iter + 1;
    }
    return 0;
}
</textarea>

<textarea id="shor7" style="display:none;">
function estimate_num_spikes(spike, range)
{
    if (spike < range / 2)
        spike = range - spike;
    best_error = 1.0;
    e0 = 0, e1 = 0, e2 = 0;
    actual = spike / range;
    candidates = []
    for (denom = 1.0; denom < spike; ++denom)
    {
        numerator = Math.round(denom * actual);
        estimated = numerator / denom;
        error = Math.abs(estimated - actual);
        e0 = e1;
        e1 = e2;
        e2 = error;
        // Look for a local minimum which beats our current best error
        if (e1 <= best_error && e1 < e0 && e1 < e2)
        {
            repeat_period = denom - 1;
            candidates.push(denom - 1);
            best_error = e1;
        }
    }
    return candidates;
}
</textarea>


<script type="text/javascript" src="http://machinelevel.com/qc/qcengine_bitfield.js"></script>
<script type="text/javascript" src="http://machinelevel.com/qc/qcengine_reg.js"></script>
<script type="text/javascript" src="http://machinelevel.com/qc/qcengine_int.js"></script>
<script type="text/javascript" src="http://machinelevel.com/qc/qcengine_basicops.js"></script>


<script type="text/javascript" src="http://machinelevel.com/qc/qcengine_widgets.js"></script>
<script type="text/javascript" src="http://machinelevel.com/qc/qcengine_blockjob.js"></script>
<script type="text/javascript" src="http://machinelevel.com/qc/qcengine_staff.js"></script>

<script type="text/javascript" src="http://machinelevel.com/qc/qcengine_setup.js"></script>
<script type="text/javascript" src="http://machinelevel.com/qc/qcengine_scriptpanel.js"></script>
<script type="text/javascript" src="http://machinelevel.com/qc/qcengine_panel.js"></script>
<script type="text/javascript" src="http://machinelevel.com/qc/qcengine_photonic.js"></script>
<script type="text/javascript" src="http://machinelevel.com/qc/qcengine_test.js"></script>
<script type="text/javascript" src="http://machinelevel.com/qc/qcengine_webgl_block.js"></script>
<script type="text/javascript" src="http://machinelevel.com/qc/qcengine_mbc.js"></script>
<script type="text/javascript" src="http://machinelevel.com/qc/qcengine_aaronson_chp.js"></script>


</body>
</html>
